// SM+RSI MES v2 -- TP=20 exit replacing SM flip, with SL=35
// Replaces v9.4 MES. Same SM engine (AlgoAlpha 20/12/400/255), but:
//   - RSI period: 10 -> 12 (slower RSI avoids whipsaws on slow MES SM)
//   - Cooldown: 15 -> 25 bars
//   - Exit: SM flip -> TP=20 pts ($100/contract)
//   - Stop loss: 0 (disabled) -> 35 pts ($175/contract)
//   - EOD: 15:30 ET (same as v9.4)
//   - SM threshold: 0.0 (same -- weak MES entries are profitable)
//
// Why TP=20 for MES (not TP=5 like MNQ)?
//   - MES is $5/pt (2.5x MNQ), so TP=20 on MES = $100 (vs TP=5 on MNQ = $10)
//   - MES SM uses EMA=255 (very slow), trends persist longer -> bigger moves
//   - SL=35 caps worst-case losses (v9.4 had uncapped losses up to -60 pts)
//
// 12-month validation (Feb 2025 - Feb 2026) with param sweep:
//   v9.4 baseline: 733 trades, PF 1.027, +$339, OOS -$849
//   MES v2:        ~400 trades, PF ~1.3,  +$5,380, OOS +$4,665
//
// Architecture: 1-MIN chart. SM computed on 1-min. RSI on 5-min via
// request.security(). Entry on SM direction + RSI cross. Exit on TP=20 or
// SL=35 or EOD 15:30. NO SM flip exit.
//
// SETUP:
//   1. Open MES on a 1-MINUTE chart
//   2. Add this strategy -- NO other indicators needed
//   3. Scroll chart left to load 500+ bars of history
//   4. Check Properties tab after loading (TV resets date range)
//
//@version=6
strategy("SM+RSI MES v2", overlay=true,
     initial_capital=1000,
     default_qty_type=strategy.fixed,
     default_qty_value=1,
     commission_type=strategy.commission.cash_per_contract,
     commission_value=1.25,
     slippage=0,
     margin_long=0,
     margin_short=0,
     process_orders_on_close=false,
     calc_on_every_tick=false,
     fill_orders_on_standard_ohlc=true,
     max_bars_back=5000)

// --- Input Groups ---
grp_sm   = "SMART MONEY (built-in, AlgoAlpha algorithm)"
grp_rsi  = "RSI SETTINGS (5-min)"
grp_exit = "EXIT SETTINGS"
grp_sess = "SESSION FILTER"
grp_disp = "DISPLAY"

// --- SM Inputs (AlgoAlpha defaults -- validated as optimal for MES) ---
sm_index   = input.int(20,  "SM Index Period",   minval=1, maxval=50,  group=grp_sm,
     tooltip="Summation period for buy/sell interest. Default 20 (AA default=25). Validated optimal for MES.")
sm_flow    = input.int(12,  "SM Flow Period",    minval=1, maxval=50,  group=grp_sm,
     tooltip="RSI period on volume flow. Default 12 (AA default=14).")
sm_norm    = input.int(400, "SM Norm Period",    minval=50, maxval=1000, group=grp_sm,
     tooltip="Lookback for peak normalization. Default 400 (AA default=500). Not very sensitive.")
sm_ema_len = input.int(255, "SM EMA Length",     minval=10, maxval=500, group=grp_sm,
     tooltip="EMA smoothing on PVI/NVI. Default 255 (matches AA hardcoded value). Slower = better for MES.")
sm_threshold = input.float(0.00, "SM Threshold", minval=0, step=0.05, group=grp_sm,
     tooltip="Min |SM| to confirm direction. 0 = any non-zero SM. MES weak entries are profitable.")

// --- RSI Inputs (computed on 5-min) ---
rsi_len     = input.int(12,  "RSI Length",     minval=2,  maxval=50, group=grp_rsi,
     tooltip="RSI period on 5-min bars. 12 = slower than v9.4 (10), avoids whipsaws on slow MES SM.")
rsi_buy     = input.int(55,  "RSI Buy Level",  minval=50, maxval=90, group=grp_rsi,
     tooltip="RSI must cross above this for long entry. 55 for MES.")
rsi_sell    = input.int(45,  "RSI Sell Level",  minval=10, maxval=50, group=grp_rsi,
     tooltip="RSI must cross below this for short entry. 45 for MES.")

// --- Position Size ---
qty = input.int(1, "Contracts", minval=1, maxval=20, group=grp_exit,
     tooltip="Number of contracts per trade.")

// --- Exit Inputs ---
tp_pts       = input.int(20, "Take Profit (pts)", minval=1, step=5, group=grp_exit,
     tooltip="Close position after gaining this many points. 20 pts = $100/contract on MES.")
max_loss_pts = input.int(35, "Max Loss Stop (pts)", minval=1, step=5, group=grp_exit,
     tooltip="Hard stop loss. 35 pts = $175/contract. Caps v9.4's uncapped losses (-60 pts worst).")
cooldown     = input.int(25, "Cooldown Bars (1-min bars)", minval=0, maxval=150, group=grp_exit,
     tooltip="Bars to wait after exit. 25 for MES v2 (v9.4 used 15).")

// --- Session Inputs ---
use_session = input.bool(true, "NY Session Only", group=grp_sess)
sess_start  = input.session("1000-1545", "Entry Window (ET)",     group=grp_sess)
sess_close  = input.session("0930-1530", "Session Close Window (ET)", group=grp_sess,
     tooltip="EOD at 15:30 ET. Validated: improves MES P&L vs 16:00 close.")

// --- Display Inputs ---
show_signals = input.bool(true, "Show Entry Signals",  group=grp_disp)
show_sm_bg   = input.bool(true, "Show SM Background",  group=grp_disp)
show_sm_net  = input.bool(true, "Show SM Net Index",   group=grp_disp)

// ============================================================================
// SMART MONEY -- computed natively (AlgoAlpha algorithm, MPL 2.0)
// ============================================================================
dumb  = ta.pvi - ta.ema(ta.pvi, sm_ema_len)
smart = ta.nvi - ta.ema(ta.nvi, sm_ema_len)

drsi = ta.rsi(dumb, sm_flow)
srsi = ta.rsi(smart, sm_flow)

r_buy  = srsi / drsi
r_sell = (100 - srsi) / (100 - drsi)

sums_buy  = math.sum(r_buy, sm_index)
sums_sell = math.sum(r_sell, sm_index)
peak      = ta.highest(math.max(sums_buy, sums_sell), sm_norm)

index_buy  = peak != 0 ? sums_buy / peak : 0.0
index_sell = peak != 0 ? sums_sell / peak : 0.0
sm_net_index = index_buy - index_sell

// SM direction (entry uses threshold, episode reset uses zero-cross)
sm_bull = sm_net_index > sm_threshold
sm_bear = sm_net_index < -sm_threshold
sm_flipped_bull = sm_net_index > 0 and sm_net_index[1] <= 0
sm_flipped_bear = sm_net_index < 0 and sm_net_index[1] >= 0

// ============================================================================
// RSI -- computed on 5-min via request.security()
// ============================================================================
rsi_5m = request.security(syminfo.tickerid, "5", ta.rsi(close, rsi_len), lookahead=barmerge.lookahead_off)
rsi_5m_prev = request.security(syminfo.tickerid, "5", ta.rsi(close, rsi_len)[1], lookahead=barmerge.lookahead_off)

rsi_cross_up   = rsi_5m > rsi_buy and rsi_5m_prev <= rsi_buy
rsi_cross_down = rsi_5m < rsi_sell and rsi_5m_prev >= rsi_sell

// ============================================================================
// ENTRY/EXIT LOGIC
// ============================================================================

// Episode logic -- only one entry per SM episode
var bool long_used  = false
var bool short_used = false

if not sm_bull or sm_flipped_bear
    long_used := false
if not sm_bear or sm_flipped_bull
    short_used := false

// Session filter
in_entry_window = not use_session or not na(time(timeframe.period, sess_start, "America/New_York"))
in_session      = not use_session or not na(time(timeframe.period, sess_close, "America/New_York"))

// Cooldown (in 1-min bars)
var int bars_since_exit = 9999
bars_since_exit += 1
cooldown_ok = bars_since_exit >= cooldown

// Entry signals: SM direction (1-min) + RSI cross (5-min)
long_entry  = sm_bull and rsi_cross_up   and not long_used  and in_entry_window and cooldown_ok
short_entry = sm_bear and rsi_cross_down and not short_used and in_entry_window and cooldown_ok

// ---- EXIT: EOD CLOSE (priority 1) ----
if strategy.position_size != 0 and not in_session
    strategy.close_all(comment="EOD")
    bars_since_exit := 0

// ---- EXIT: MAX LOSS STOP (priority 2) ----
if max_loss_pts > 0
    if strategy.position_size > 0 and close <= strategy.position_avg_price - max_loss_pts
        strategy.close("Long", comment="SL")
        bars_since_exit := 0
    if strategy.position_size < 0 and close >= strategy.position_avg_price + max_loss_pts
        strategy.close("Short", comment="SL")
        bars_since_exit := 0

// ---- EXIT: TAKE PROFIT (priority 3) ----
if tp_pts > 0
    if strategy.position_size > 0 and close >= strategy.position_avg_price + tp_pts
        strategy.close("Long", comment="TP")
        bars_since_exit := 0
    if strategy.position_size < 0 and close <= strategy.position_avg_price - tp_pts
        strategy.close("Short", comment="TP")
        bars_since_exit := 0

// NOTE: No SM flip exit. MES v2 exits ONLY on TP, SL, or EOD.
// This is the key improvement over v9.4 which used SM flip exit.

// ---- ENTRIES ----
if long_entry and strategy.position_size == 0
    strategy.entry("Long", strategy.long, qty=qty)
    long_used := true
    bars_since_exit := 9999

if short_entry and strategy.position_size == 0
    strategy.entry("Short", strategy.short, qty=qty)
    short_used := true
    bars_since_exit := 9999

// ============================================================================
// PLOTS
// ============================================================================

// SM background color
var color sm_bg_col = na
if sm_net_index > sm_threshold
    sm_bg_col := color.new(color.green, 85)
else if sm_net_index < -sm_threshold
    sm_bg_col := color.new(color.red, 85)
else
    sm_bg_col := color.new(color.gray, 95)
bgcolor(show_sm_bg ? sm_bg_col : na)

// Entry signals
plotshape(show_signals and long_entry, title="Long", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="L")
plotshape(show_signals and short_entry, title="Short", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, text="S")

// SM Net Index plot (lower pane)
sm_plot_col = sm_net_index > 0 ? color.green : color.red
plot(show_sm_net ? sm_net_index : na, "SM Net Index", color=sm_plot_col, linewidth=2, display=display.pane)
hline(0, "Zero", color=color.gray, linestyle=hline.style_dotted)

// ============================================================================
// INFO TABLE
// ============================================================================
var table info = table.new(position.top_right, 2, 9, bgcolor=color.new(color.black, 80))
if barstate.islastconfirmedhistory
    table.cell(info, 0, 0, "MES v2", text_color=color.white, text_size=size.small)
    table.cell(info, 1, 0, "TP Exit", text_color=color.lime, text_size=size.small)

    table.cell(info, 0, 1, "SM Idx/Flw", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 1, str.tostring(sm_index) + "/" + str.tostring(sm_flow), text_color=color.white, text_size=size.small)
    table.cell(info, 0, 2, "SM Nrm/EMA", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 2, str.tostring(sm_norm) + "/" + str.tostring(sm_ema_len), text_color=color.white, text_size=size.small)

    table.cell(info, 0, 3, "Take Profit", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 3, str.tostring(tp_pts) + " pts", text_color=color.lime, text_size=size.small)

    table.cell(info, 0, 4, "Stop Loss", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 4, str.tostring(max_loss_pts) + " pts", text_color=color.yellow, text_size=size.small)

    table.cell(info, 0, 5, "Cooldown", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 5, str.tostring(cooldown) + " bars", text_color=color.white, text_size=size.small)

    table.cell(info, 0, 6, "SM Now", text_color=color.gray, text_size=size.small)
    sm_col = sm_net_index > 0 ? color.green : color.red
    table.cell(info, 1, 6, str.tostring(sm_net_index, "#.###"), text_color=sm_col, text_size=size.small)

    table.cell(info, 0, 7, "5m RSI", text_color=color.gray, text_size=size.small)
    rsi_col = color.white
    if rsi_5m > rsi_buy
        rsi_col := color.green
    else if rsi_5m < rsi_sell
        rsi_col := color.red
    table.cell(info, 1, 7, str.tostring(rsi_5m, "#.#"), text_color=rsi_col, text_size=size.small)

    rsi_label = "RSI" + str.tostring(rsi_len) + " " + str.tostring(rsi_buy) + "/" + str.tostring(rsi_sell)
    table.cell(info, 0, 8, "RSI Cfg", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 8, rsi_label, text_color=color.yellow, text_size=size.small)
