// ═══════════════════════════════════════════════════════════════════════════
// 15-Point Scalper v3 — SM_med + RSI 14 (65/35) — FIXED
// ═══════════════════════════════════════════════════════════════════════════
// Fixes from v2:
//   1. Session starts at 10:00 AM ET (not 9:30)
//   2. Bulletproof re-entry prevention using var state tracking
//   3. Bars-since-entry cooldown instead of relying on position_size timing
//   4. RSI must fully return to neutral zone (between 35-65) before re-firing
//   5. Only one trade per direction per SM regime
//
// SM params: Index=20, Flow=12, Norm=400, EMA=200
// RSI 14, Buy=65, Sell=35, SM threshold > 0.10
// TP 15 / SL 7 | NY session: 10:00 AM - 3:45 PM ET
//
// Apply to 5-MINUTE MNQ chart.
// ═══════════════════════════════════════════════════════════════════════════

//@version=6
strategy("15pt Scalper v3", overlay=true, initial_capital=1000,
     default_qty_type=strategy.fixed, default_qty_value=1,
     commission_type=strategy.commission.cash_per_contract, commission_value=0.52,
     slippage=0, margin_long=0, margin_short=0,
     calc_on_every_tick=false, fill_orders_on_standard_ohlc=true,
     process_orders_on_close=false)

// ─── Inputs ──────────────────────────────────────────────────────────────────
grp_sm  = "Smart Money Settings"
sm_index_period  = input.int(20,  "SM Index Period",         minval=1, group=grp_sm)
sm_flow_period   = input.int(12,  "SM Volume Flow Period",   minval=1, group=grp_sm)
sm_norm_period   = input.int(400, "SM Normalization Period",  minval=1, group=grp_sm)
sm_ema_len       = input.int(200, "SM EMA Length",            minval=1, group=grp_sm)
sm_threshold     = input.float(0.10, "SM Net Index Threshold", minval=0, step=0.01, group=grp_sm)

grp_rsi = "RSI Settings"
rsi_len    = input.int(14,   "RSI Length",     minval=1,  group=grp_rsi)
rsi_buy    = input.float(65, "RSI Buy Level",             group=grp_rsi)
rsi_sell   = input.float(35, "RSI Sell Level",            group=grp_rsi)

grp_exit = "Exit Settings"
tp_pts     = input.float(15, "Take Profit (points)", group=grp_exit)
sl_pts     = input.float(7,  "Stop Loss (points)",   group=grp_exit)
cooldown   = input.int(6,    "Cooldown Bars After Exit", minval=1, maxval=100, group=grp_exit,
             tooltip="Min bars to wait after an exit before new entry. 6 bars = 30 min on 5-min chart.")

grp_sess = "Session Filter"
use_session = input.bool(true, "NY Session Only", group=grp_sess)
sess_entry  = input.session("1000-1545", "Entry Window (ET)", group=grp_sess,
              tooltip="No new entries before 10:00 AM or after 3:45 PM ET")
sess_close  = input.session("0930-1600", "Session Close Window (ET)", group=grp_sess,
              tooltip="Force close all positions outside this window")

grp_disp = "Display"
show_signals  = input.bool(true,  "Show Entry Signals",   group=grp_disp)
show_bg       = input.bool(true,  "Show SM Background",   group=grp_disp)
show_sm_plot  = input.bool(false, "Show SM Net Index",     group=grp_disp)

// ─── Manual PVI / NVI Calculation ────────────────────────────────────────────
var float pvi = 1.0
var float nvi = 1.0

float pct_change = close[1] != 0 ? (close - close[1]) / close[1] : 0.0

if bar_index > 0
    if volume > volume[1]
        pvi := pvi[1] + pct_change * pvi[1]
        nvi := nvi[1]
    else if volume < volume[1]
        nvi := nvi[1] + pct_change * nvi[1]
        pvi := pvi[1]
    else
        pvi := pvi[1]
        nvi := nvi[1]

// ─── Smart Money Volume Index ────────────────────────────────────────────────
dumb  = pvi - ta.ema(pvi, sm_ema_len)
smart = nvi - ta.ema(nvi, sm_ema_len)

drsi = ta.rsi(dumb, sm_flow_period)
srsi = ta.rsi(smart, sm_flow_period)

r_buy  = nz(drsi) != 0 ? nz(srsi) / nz(drsi) : 0.0
r_sell = (100 - nz(drsi)) != 0 ? (100 - nz(srsi)) / (100 - nz(drsi)) : 0.0

sums_buy  = math.sum(r_buy, sm_index_period)
sums_sell = math.sum(r_sell, sm_index_period)
peak      = ta.highest(math.max(sums_buy, sums_sell), sm_norm_period)

index_buy  = peak != 0 ? sums_buy / peak : 0.0
index_sell = peak != 0 ? sums_sell / peak : 0.0
net_index  = index_buy - index_sell

// ─── RSI ─────────────────────────────────────────────────────────────────────
rsi_val = ta.rsi(close, rsi_len)

// Fresh crossover: RSI just crossed this bar
rsi_cross_up = ta.crossover(rsi_val, rsi_buy)
rsi_cross_dn = ta.crossunder(rsi_val, rsi_sell)

// ─── SM Direction ────────────────────────────────────────────────────────────
sm_bullish = net_index > sm_threshold
sm_bearish = net_index < -sm_threshold

// ─── Session Filter ──────────────────────────────────────────────────────────
in_entry_window = use_session ? not na(time(timeframe.period, sess_entry, "America/New_York")) : true
in_full_session = use_session ? not na(time(timeframe.period, sess_close, "America/New_York")) : true

// ─── Trade State Machine ─────────────────────────────────────────────────────
// This replaces strategy.position_size checks which have timing issues in TV.
// We track our own state to guarantee no same-bar re-entries.

var int   trade_state = 0        // 0=flat, 1=long, -1=short
var int   entry_bar   = -9999    // bar_index when we entered
var int   exit_bar    = -9999    // bar_index when we last exited
var bool  rsi_was_neutral = true // RSI has returned to 35-65 zone since last trade

// Detect RSI in neutral zone (between sell and buy levels)
rsi_in_neutral = rsi_val > rsi_sell and rsi_val < rsi_buy

// Once RSI returns to neutral after a trade, allow new entries
if rsi_in_neutral and trade_state == 0
    rsi_was_neutral := true

// Cooldown check: enough bars since last exit
bars_since_exit = bar_index - exit_bar
cooldown_ok = bars_since_exit >= cooldown

// ─── Detect Exits (TP/SL filled) ────────────────────────────────────────────
// Check if our tracked position was closed by the strategy engine
pos_went_flat = strategy.position_size == 0 and trade_state != 0

if pos_went_flat
    trade_state     := 0
    exit_bar        := bar_index
    rsi_was_neutral := false  // must reset through neutral before next trade

// ─── Entry Logic ─────────────────────────────────────────────────────────────
can_trade = trade_state == 0 and cooldown_ok and rsi_was_neutral and in_entry_window

long_signal  = can_trade and rsi_cross_up and sm_bullish
short_signal = can_trade and rsi_cross_dn and sm_bearish

if long_signal
    strategy.entry("Long", strategy.long)
    trade_state     := 1
    entry_bar       := bar_index
    rsi_was_neutral := false

if short_signal
    strategy.entry("Short", strategy.short)
    trade_state     := -1
    entry_bar       := bar_index
    rsi_was_neutral := false

// ─── TP/SL Exits ────────────────────────────────────────────────────────────
if strategy.position_size > 0
    strategy.exit("Long TP/SL", "Long",
         profit = tp_pts / syminfo.mintick,
         loss   = sl_pts / syminfo.mintick)

if strategy.position_size < 0
    strategy.exit("Short TP/SL", "Short",
         profit = tp_pts / syminfo.mintick,
         loss   = sl_pts / syminfo.mintick)

// ─── EOD Close ──────────────────────────────────────────────────────────────
if use_session and not in_full_session and strategy.position_size != 0
    strategy.close_all("EOD Close")
    trade_state     := 0
    exit_bar        := bar_index
    rsi_was_neutral := false

// ─── Visual Signals ──────────────────────────────────────────────────────────
plotshape(show_signals and long_signal ? low : na, title="Long",
     style=shape.triangleup, location=location.belowbar,
     color=color.new(#00e676, 0), size=size.small, text="L")

plotshape(show_signals and short_signal ? high : na, title="Short",
     style=shape.triangledown, location=location.abovebar,
     color=color.new(#ff1744, 0), size=size.small, text="S")

// SM background tint
sm_bg = show_bg ? (sm_bullish ? color.new(#00e676, 93) : sm_bearish ? color.new(#ff1744, 93) : na) : na
bgcolor(sm_bg, title="SM Direction")

// Session shading — dim when outside entry window
sess_bg = use_session and not in_entry_window ? color.new(color.gray, 95) : na
bgcolor(sess_bg, title="Outside Entry Window")

// Color bars by RSI state
bar_col = rsi_val > rsi_buy ? color.new(#2196f3, 30) : rsi_val < rsi_sell ? color.new(#e040fb, 30) : na
barcolor(bar_col, title="RSI State")

// ─── Lower Pane Plots ───────────────────────────────────────────────────────
plot(show_sm_plot ? net_index : na, "SM Net Index",
     color=net_index > 0 ? #00e676 : #ff1744, linewidth=2)
hline(0, "Zero", color=color.gray, linestyle=hline.style_dotted)

// ─── Info Table ──────────────────────────────────────────────────────────────
var table info = table.new(position.top_right, 2, 9, bgcolor=color.new(#1e1e1e, 10))
if barstate.islast
    table.cell(info, 0, 0, "15pt Scalper v3", text_color=color.white, text_size=size.small)
    table.cell(info, 1, 0, "SM_med", text_color=#00e676, text_size=size.small)
    table.cell(info, 0, 1, "SM", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 1, str.tostring(sm_index_period) + "/" + str.tostring(sm_flow_period) + "/" + str.tostring(sm_norm_period) + "/" + str.tostring(sm_ema_len), text_color=color.white, text_size=size.tiny)
    table.cell(info, 0, 2, "RSI", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 2, str.tostring(rsi_len) + " (" + str.tostring(rsi_buy, "#") + "/" + str.tostring(rsi_sell, "#") + ")", text_color=color.white, text_size=size.tiny)
    table.cell(info, 0, 3, "TP/SL", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 3, str.tostring(tp_pts, "#") + " / " + str.tostring(sl_pts, "#"), text_color=color.white, text_size=size.tiny)
    table.cell(info, 0, 4, "Cooldown", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 4, str.tostring(cooldown) + " bars (" + str.tostring(cooldown * 5) + " min)", text_color=color.white, text_size=size.tiny)
    table.cell(info, 0, 5, "Window", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 5, "10:00-3:45 ET", text_color=color.white, text_size=size.tiny)
    table.cell(info, 0, 6, "SM Net", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 6, str.tostring(net_index, "#.###"), text_color=net_index > sm_threshold ? #00e676 : net_index < -sm_threshold ? #ff1744 : color.gray, text_size=size.tiny)
    table.cell(info, 0, 7, "RSI", text_color=color.gray, text_size=size.tiny)
    table.cell(info, 1, 7, str.tostring(rsi_val, "#.#"), text_color=rsi_val > rsi_buy ? #2196f3 : rsi_val < rsi_sell ? #e040fb : color.white, text_size=size.tiny)
    table.cell(info, 0, 8, "State", text_color=color.gray, text_size=size.tiny)
    state_txt = trade_state == 1 ? "LONG" : trade_state == -1 ? "SHORT" : can_trade ? "READY" : "WAIT"
    state_col = trade_state != 0 ? #2196f3 : can_trade ? #00e676 : #ff1744
    table.cell(info, 1, 8, state_txt + (in_entry_window ? "" : " [CLOSED]"), text_color=state_col, text_size=size.tiny)
